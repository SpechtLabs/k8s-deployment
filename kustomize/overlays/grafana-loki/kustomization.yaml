apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: observability

bases:
  - ../../bases/grafana-loki

generators:
  - ./secret-generator.yaml

resources:
  - servicemonitor.yaml

patchesJson6902:
  - target:
      kind: StatefulSet
      group: apps
      version: v1
      name: loki-read
    patch: |-
      - op: remove
        path: /spec/persistentVolumeClaimRetentionPolicy

  - target:
      kind: (StatefulSet|Deployment)
      group: apps
      version: v1
      name: ".*"
    patch: |-
      - op: replace
        path: /spec/template/spec/affinity/podAntiAffinity/requiredDuringSchedulingIgnoredDuringExecution/0/topologyKey
        value: topology.kubernetes.io/region
