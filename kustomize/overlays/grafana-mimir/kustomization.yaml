apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: observability

bases:
  - ../../bases/grafana-mimir

resources:
  - opentelemetry.yaml

generators:
  - ./secret-generator.yaml

patches:
  - nginx-config.yaml

patchesJson6902:
  - target:
      kind: ServiceMonitor
      namespace: observability
      name: "mimir-.*"
    path: service-monitor.patch.yaml

  - target:
      kind: HorizontalPodAutoscaler
      group: autoscaling
      version: v2beta1
      name: ".*"
    patch: |-
      - op: replace
        path: "/apiVersion"
        value: "autoscaling/v2"

      - op: remove
        path: "/spec/metrics/0/resource/targetAverageUtilization"

      - op: add
        path: /spec/metrics/0/resource/target
        value:
          type: Utilization
          averageUtilization: 60
