argo-cd:
  fullnameOverride: argocd
  dex:
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        selector:
          scope: k8s-av0-de
  redis:
    serviceAccount:
      create: true
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        selector:
          scope: k8s-av0-de

  repoServer:
    image:
      repository: "ghcr.io/av0de/argocd-custom-container"
    volumes:
    - name: helm-secrets
      secret:
        secretName: helm-secrets
    volumeMounts:
      - mountPath: /helm-secrets/
        name: helm-secrets

  server:
    image:
      repository: "ghcr.io/av0de/argocd-custom-container"
    certificate:
      enabled: false
      domain: argo.av0.de
    config:
      url: https://argo.av0.de
      dex.config: |
        connectors:
          - type: github
            id: github
            name: GitHub
            config:
              clientID: $dex.oauth.github.clientID
              clientSecret: $dex.oauth.github.clientSecret
              orgs:
                - name: av0-de
      configManagementPlugins: |
        - name: helmSecrets
          init:
            command: ["gpg"]
            args: ["--import", "/home/argocd/gpg/gpg.asc"] # is mounted as a kube secret
          generate:
            command: ["/bin/sh", "-c"]
            args: ["helm secrets template $HELM_OPTS $RELEASE_NAME ."]
    ingress:
      enabled: true
      https: true
      pathType: ImplementationSpecific
      hosts:
        - argo.av0.de
      tls:
        - hosts:
            - argo.av0.de
          secretName: argocd-secret
      annotations:
        "cert-manager.io/cluster-issuer": "letsencrypt-prod"
        "kubernetes.io/ingress.class": nginx
        "nginx.ingress.kubernetes.io/backend-protocol": HTTPS
        "nginx.ingress.kubernetes.io/ssl-passthrough": "true"
    rbacConfig:
      policy.default: role:readonly
      policy.csv: |
        p, role:org-admin, applications, *, */*, allow
        p, role:org-admin, clusters, *, *, allow
        p, role:org-admin, repositories, *, *, allow
        p, role:org-admin, projects, *, *, allow
        g, "av0de", role:org-admin
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        selector:
          scope: k8s-av0-de

  controller:
    metrics:
      enabled: true

  configs:
    secret:
      extra:
        dex.oauth.github.clientID: test455 # TODO encrypt and use real values
        dex.oauth.github.clientSecret: test123 # TODO encrypt and use real values